<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> FormData和AJAX上传 · Jax Blog</title><meta name="description" content="FormData和AJAX上传 - Jax"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://jaxcode.github.io/atom.xml" title="Jax Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jaxcode" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">FormData和AJAX上传</h1><div class="post-info">2017年4月17日</div><div class="post-content"><p>使用HTML5新标准的<code>FormData</code>和<code>XHR2</code>来实现表单的提交和文件的上传功能.<br><a id="more"></a></p>
<h3 id="FormData的创建"><a href="#FormData的创建" class="headerlink" title="FormData的创建"></a>FormData的创建</h3><p><code>FormData()</code>构造函数用于创建一个FormData对象.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个空的FormData对象</span></div><div class="line"><span class="keyword">var</span> oFormData = <span class="keyword">new</span> FormData();</div></pre></td></tr></table></figure></p>
<p><code>FormData()</code>有一个可选参数: <code>form</code>. 该参数用来指定一个表单元素.</p>
<p>通过这种方式常见的<code>FormData</code>中会存在数据, 为表单每一项的键和值. (如果不设置表单输入元素的name属性, 将无法获得键和值)<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">placeholder</span>=<span class="string">"姓名"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">placeholder</span>=<span class="string">"年龄"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用可选的form参数创建一个FormData对象</span></div><div class="line"><span class="keyword">var</span> oForm = <span class="built_in">document</span>.querySelector(<span class="string">'form'</span>);</div><div class="line"><span class="keyword">var</span> oFormData = <span class="keyword">new</span> FormData(oForm);</div></pre></td></tr></table></figure>
<h3 id="append方法"><a href="#append方法" class="headerlink" title="append方法"></a>append方法</h3><p><code>FormData</code>对象可以通过<code>append()</code>方法来添加数据, 它接收两个参数, 分别是键和值<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> oFormData = <span class="keyword">new</span> FormData();</div><div class="line">oFormData.append(<span class="string">'name'</span>, <span class="string">'jax'</span>);</div></pre></td></tr></table></figure></p>
<p>对于通过form参数创建的<code>FormData</code>对象也可以使用<code>append</code>方法追加数据进去.</p>
<h3 id="ajax提交表单的实例"><a href="#ajax提交表单的实例" class="headerlink" title="ajax提交表单的实例"></a>ajax提交表单的实例</h3><p>结合<code>FormData</code>对象, 我们就可以通过ajax去提交表单数据, 而且可以通过<code>append</code>在提交前任意的添加项. 我们来创建一个简单的提交实例.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">placeholder</span>=<span class="string">"姓名"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">placeholder</span>=<span class="string">"年龄"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> oDiv = <span class="built_in">document</span>.querySelector(<span class="string">'div'</span>);</div><div class="line"><span class="keyword">var</span> oForm = <span class="built_in">document</span>.querySelector(<span class="string">'form'</span>);</div><div class="line"></div><div class="line">oForm.addEventListener(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> e = e || event;</div><div class="line"></div><div class="line">    <span class="comment">// 取消表单提交的默认事件</span></div><div class="line">    e.preventDefault();</div><div class="line"></div><div class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">    xhr.open(<span class="string">'POST'</span>, <span class="string">'http://localhost/php/index.php'</span>, <span class="literal">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// onload: 当一个HTTP请求正确加载出内容后返回时调用</span></div><div class="line">    xhr.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</div><div class="line">            oDiv.innerHTML = xhr.response;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    oFormData = <span class="keyword">new</span> FormData(oForm);</div><div class="line">    <span class="comment">// 追加提交时间项.</span></div><div class="line">    oFormData.append(<span class="string">'date'</span>, +<span class="keyword">new</span> <span class="built_in">Date</span>());</div><div class="line">    xhr.send(oFormData);</div><div class="line">&#125;, <span class="literal">false</span>);</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    <span class="comment">// index.php</span></div><div class="line">    $name = (<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>])) ? $_POST[<span class="string">'name'</span>] : <span class="string">'no name'</span>;</div><div class="line">    $age = (<span class="keyword">isset</span>($_POST[<span class="string">'age'</span>])) ? $_POST[<span class="string">'age'</span>] : <span class="string">'no age'</span>;</div><div class="line">    $date = $_POST[<span class="string">'date'</span>];</div><div class="line">    <span class="keyword">echo</span> <span class="string">'name: '</span>, $name, <span class="string">'&lt;br /&gt;age: '</span>, $age, <span class="string">'&lt;br /&gt;date: '</span>, $date;</div></pre></td></tr></table></figure>
<div class="tip"><br>在这个小例子中并没有做兼容性和错误处理, 在实际工作项目中, 应该加上这些. 或者使用一些封装的库来实现这个功能.<br></div>

<h3 id="文件的上传"><a href="#文件的上传" class="headerlink" title="文件的上传"></a>文件的上传</h3><p>使用<code>formData</code>来上传文件是非常简单的. 我们仍然使用上一个例子的js代码. 只需要在表单中添加上传文件. 甚至都不需要设置表单的<code>enctype</code>属性就可以实现文件的上传.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在某些情况下. 可能会需要设置<code>enctype</code>和请求头信息才能生效. 这里也备注一下:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xhr.setRequestHeader(<span class="string">'X-Request-With'</span>, <span class="string">'XMLHttpRequest'</span>);</div></pre></td></tr></table></figure>
<h3 id="文件上传的进度"><a href="#文件上传的进度" class="headerlink" title="文件上传的进度"></a>文件上传的进度</h3><p><code>onprogress</code>: 间歇调用该方法用来获取请求过程中的信息.</p>
<p>在一般请求中, 使用<code>xhr.onprogress</code>, 但是在文件上传中, 使用<code>xhr.upload.onprogress</code>.</p>
<p>这是因为<code>XHR2</code>的实例中会有一个专门的<code>upload</code>对象, 用来表示上传的进度. 可以通过绑定事件来追踪进度.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">xhr.upload.onprogress = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> e = e || event;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'文件总大小: '</span> + e.total);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'已上传大小: '</span> + e.loaded);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/17/this指向总结/" class="prev">PREV</a><a href="/2017/04/23/写一个漂亮的渐变按钮/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 <a href="http://jaxcode.github.io">Jax</a>, email: 13486062822@163.com</p><script src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async="async"></script></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>